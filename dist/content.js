(()=>{"use strict";var e={913:function(e,t,o){var i=this&&this.__awaiter||function(e,t,o,i){return new(o||(o=Promise))((function(n,s){function l(e){try{d(i.next(e))}catch(e){s(e)}}function a(e){try{d(i.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(l,a)}d((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.initialize=t.getConfig=t.setDefault=t.CONFIG_VERSION=void 0;const n=o(473);t.CONFIG_VERSION=2;const s={version:t.CONFIG_VERSION,useDesktopNotification:!0,useDiscordNotification:!1,discordWebhookUrl:"",discordMention:"",autoOpenChapterWhenOpenPage:!1,useAutoNext:!0,useAutoNextContainsSupplements:!1,useAutoNextNotGoodOnly:!0,useAutoPauseUnblock:!0,useSeekUnblock:!0,notifyVideoStateChange:!1,discordPlaybackStartedMessage:"%mention% 教材動画 `%title%` の再生を開始しました",discordPlaybackEndedMessage:"%mention% 教材動画 `%title%` の再生が終了しました",discordTakeTestMessage:"%mention% テスト `%title%` を受けてください",desktopPlaybackStarted:"教材動画の再生を開始しました",desktopPlaybackEnded:"教材動画の再生が終了しました",desktopTakeTest:"テストを受けてください",unknownVideo:"不明な動画",unknownTest:"不明なテスト"};function l(){return i(this,void 0,void 0,(function*(){yield chrome.storage.sync.clear(),yield chrome.storage.sync.set(s),(0,n.log)("Config",n.Level.INFO,"Configuration initialized.")}))}function a(){return i(this,void 0,void 0,(function*(){if(0==(yield chrome.storage.sync.getBytesInUse()))(0,n.log)("Config",n.Level.INFO,"Configuration not found, writing default configuration."),yield l();else{let e=yield chrome.storage.sync.get();if(!e.version){(0,n.log)("Config",n.Level.INFO,"Configuration migrate required. You're using config version 1.");const t={version:2,useDesktopNotification:e.useDesktopNotification,useDiscordNotification:e.useDiscordNotification,discordWebhookUrl:e.discordWebhookUrl,discordMention:e.discordMention,autoOpenChapterWhenOpenPage:e.startPlaybackWhenOpenPage,useAutoNext:e.useAutoNext,useAutoNextContainsSupplements:e.useAutoNextContainsSupplements,useAutoNextNotGoodOnly:e.useAutoNextNotGoodOnly,useAutoPauseUnblock:e.useAutoPauseUnblock,useSeekUnblock:e.useSeekUnblock,notifyVideoStateChange:e.notifyVideoStateChange,discordPlaybackStartedMessage:e.discordPlaybackStartedMessage,discordPlaybackEndedMessage:e.discordPlaybackEndedMessage,discordTakeTestMessage:e.discordTakeTestMessage,desktopPlaybackStarted:e.desktopPlaybackStarted,desktopPlaybackEnded:e.desktopPlaybackEnded,desktopTakeTest:e.desktopTakeTest,unknownVideo:e.unknownVideo,unknownTest:e.unknownTest};yield chrome.storage.sync.clear(),yield chrome.storage.sync.set(t)}if(e.version!=s.version){if(2==e.version){let t={version:3,useDesktopNotification:e.useDesktopNotification,useDiscordNotification:e.useDiscordNotification,discordWebhookUrl:e.discordWebhookUrl,discordMention:e.discordMention,autoOpenChapterWhenOpenPage:e.autoOpenChapterWhenOpenPage,useAutoNext:e.useAutoNext,useAutoNextContainsSupplements:e.useAutoNextContainsSupplements,useAutoNextNotGoodOnly:e.useAutoNextNotGoodOnly,useAutoPauseUnblock:e.useAutoPauseUnblock,useSeekUnblock:e.useSeekUnblock,notifyVideoStateChange:e.notifyVideoStateChange,discordPlaybackStartedMessage:e.discordPlaybackStartedMessage,discordPlaybackEndedMessage:e.discordPlaybackEndedMessage,discordTakeTestMessage:e.discordTakeTestMessage,desktopPlaybackStarted:e.desktopPlaybackStarted,desktopPlaybackEnded:e.desktopPlaybackEnded,desktopTakeTest:e.desktopTakeTest,unknownVideo:e.unknownVideo,unknownTest:e.unknownTest};yield chrome.storage.sync.clear(),yield chrome.storage.sync.set(t),e=yield chrome.storage.sync.get()}e.version}}}))}t.setDefault=l,t.getConfig=function(){return i(this,void 0,void 0,(function*(){return yield a(),yield chrome.storage.sync.get()}))},t.initialize=a},144:function(e,t,o){var i=this&&this.__awaiter||function(e,t,o,i){return new(o||(o=Promise))((function(n,s){function l(e){try{d(i.next(e))}catch(e){s(e)}}function a(e){try{d(i.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(l,a)}d((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const n=o(473),s=o(913);function l(e){return i(this,void 0,void 0,(function*(){if((0,n.log)("iFrame",n.Level.INFO,"Checking iFrame contentWindow..."),null!=e.contentWindow){(0,n.log)("iFrame",n.Level.INFO,"Successfully get iFrame document."),(0,n.log)("iFrame",n.Level.INFO,"Finding VideoPlayer (#video-player)");const t=e.contentWindow.document.getElementById("video-player");null!=t?((0,n.log)("VideoPlayer",n.Level.INFO,"Successfully found video! "+t),(0,n.log)("VideoPlayer",n.Level.INFO,'Registering "ended" event to target video!'),t.addEventListener("ended",y),(0,n.log)("VideoPlayer",n.Level.INFO,'Successfully registered "ended" event to target video!'),(0,n.log)("VideoPlayer",n.Level.INFO,'Registering "pause" event to target video!'),t.addEventListener("pause",(e=>i(this,void 0,void 0,(function*(){(yield(0,s.getConfig)()).useAutoPauseUnblock&&t.currentTime!=t.duration&&((0,n.log)("VideoPlayer",n.Level.INFO,"\nDamn, that trashy high school just paused the video!\nI'll never forgive you! I'm gonna resume playback!\nLMAO."),e.preventDefault(),e.stopImmediatePropagation(),yield t.play())})))),(0,n.log)("VideoPlayer",n.Level.INFO,'Successfully registered "pause" event to target video!'),(yield(0,s.getConfig)()).useSeekUnblock&&((0,n.log)("VideoPlayer",n.Level.INFO,'Registering "seeking" event to target video!'),t.addEventListener("seeking",p),(0,n.log)("VideoPlayer",n.Level.INFO,'Successfully registered "seeking" event to target video!'),(0,n.log)("VideoPlayer",n.Level.INFO,'Registering "seeked" event to target video!'),t.addEventListener("seeked",p),(0,n.log)("VideoPlayer",n.Level.INFO,'Successfully registered "seeked" event to target video!'))):(0,n.log)("VideoPlayer",n.Level.ERROR,"Failed to find video!")}else(0,n.log)("iFrame",n.Level.ERROR,"Failed to get iFrame document!")}))}function a(e,t){if(e.useDiscordNotification&&e.discordWebhookUrl.length>0&&e.discordWebhookUrl.startsWith("https://discord.com/api/webhooks/")){(0,n.log)("Notify/Discord",n.Level.INFO,"Sending notification to discord.");const o=new XMLHttpRequest;o.open("POST",e.discordWebhookUrl),o.setRequestHeader("Content-Type","application/json"),o.addEventListener("readystatechange",(e=>{4==o.readyState&&(204==o.status?(0,n.log)("Notify/Discord",n.Level.INFO,"Successfully sent notification to discord."):400==o.status&&((0,n.log)("Notify/Discord",n.Level.WARN,"Failed to sent notification to discord."),(0,n.log)("Notify/Discord",n.Level.WARN,o.responseText)))})),t=t.replace("%mention%",e.discordMention),o.send(JSON.stringify({username:"N予備校",avatar_url:"https://www.ryuuta0217.com/nnn.ed.nico.png",content:t}))}}function d(e,t,o){if(e.useDesktopNotification){const e=new Notification(t,{body:o,icon:"https://www.nnn.ed.nico/favicon.ico"});setTimeout(e.close.bind(e),3e3)}}function r(){const e=document.querySelectorAll("div.l-contents#sections-contents>div.section>div.u-card>ul.u-list>li"),t=[];return e.forEach(((e,o)=>{const i=e.className,n=e.getElementsByTagName("a");let s=-1;if(i.includes("movie")){const t=e.querySelector("a>div.section-optional-info>p.content-amount.movie-length").innerText.split(":");2==t.length?s=60*Number(t[0])+Number(t[1]):3==t.length&&(s=60*Number(t[0])*60+60*Number(t[1])+Number(t[2]))}t[o]={title:e.querySelector("a>div.section-main-info>div>p>span.title").innerText,isGood:i.includes("good"),isMovie:i.includes("movie"),isSupplement:i.includes("supplement"),isEvaluationTest:i.includes("evaluation-test"),isEssayTest:i.includes("essay-test"),isOpened:n.length>0&&n[0].className.includes("is-selected"),isGateClosed:n.length>0&&n[0].className.includes("is-gate-closed"),movieTimeSeconds:s,element:e,clickTarget:n.length>0?n[0]:null}})),t}function c(){const e=r().filter((e=>e.isOpened));return e.length>0?e[0]:null}function u(e,t){(0,n.log)("Chapter",n.Level.INFO,"Finding next required chapter...");const o=r().filter((t=>(t.isMovie||t.isEvaluationTest||t.isEssayTest)&&(e?t.isSupplement:!t.isSupplement)));(0,n.log)("Chapter",n.Level.INFO,"Got "+o.length+" chapters.");const i=o.findIndex(((e,t,o)=>e.isOpened));let s;if(-1!=i?((0,n.log)("Chapter",n.Level.INFO,"Currently opened chapter index is "+i),s=i+1):((0,n.log)("Chapter",n.Level.INFO,"Currently not opened chapter, gathering next pos"),s=o.findIndex(((e,o,i)=>!e.isGateClosed&&(t&&!e.isGood||!t&&e.isGood)))),(0,n.log)("Chapter",n.Level.INFO,"Next chapter index is "+s),s<o.length){let e=o[s];if((0,n.log)("Chapter",n.Level.INFO,"Next chapter found: "+e.title),t&&e.isGood){for((0,n.log)("Chapter",n.Level.INFO,"Flag notGoodOnly is active. Next chapter is Good, search Chapter that is not Good.");null!=e&&e.isGood;)s+=1,e=s<o.length?o[s]:null;(0,n.log)("Chapter",n.Level.INFO,"Search ended, chapter: "+(null!=e?e.title:"null"))}if(null!=e)return(0,n.log)("Chapter",n.Level.INFO,"Found chapter: "+e.title),e}return null}function g(){return i(this,void 0,void 0,(function*(){const e=function(e){const t=r().filter((t=>(t.isMovie||t.isEvaluationTest||t.isEssayTest)&&(e?t.isSupplement:!t.isSupplement))),o=t.findIndex(((e,t,o)=>e.isOpened));let i;if(i=-1!=o?o+1:t.findIndex(((e,t,o)=>!e.isGateClosed&&!e.isGood)),i>0&&i<t.length){const e=t[i];if(e.isMovie&&!e.isGateClosed)return e}return null}(!1);return null!=e&&((0,n.log)("Automation",n.Level.INFO,"Clicking next chapter..."),f(e.clickTarget),(0,n.log)("Automation",n.Level.INFO,"Sending playback started notification"),yield function(e){return i(this,void 0,void 0,(function*(){if(null!=e&&e.isMovie){const t=yield(0,s.getConfig)();t.notifyVideoStateChange&&((0,n.log)("Notify",n.Level.INFO,"Notifying video playback started."),a(t,t.discordPlaybackStartedMessage.replace("%title%",e.title)),d(t,t.desktopPlaybackStarted,e.title),(0,n.log)("Notify",n.Level.INFO,"Successfully sent video playback started notify."))}}))}(e),!0)}))}function v(){return i(this,void 0,void 0,(function*(){const e=function(){const e=r().filter((e=>(e.isEssayTest||e.isEvaluationTest)&&!e.isGateClosed&&!e.isGood&&!e.isOpened));return e.length>0?e[0]:null}();return null!=e&&(f(e.clickTarget),yield function(e){return i(this,void 0,void 0,(function*(){if(null!=e&&(e.isEssayTest||e.isEvaluationTest)){const t=yield(0,s.getConfig)();a(t,t.discordTakeTestMessage.replace("%title%",e.title)),d(t,t.desktopTakeTest,e.title)}}))}(e),!0)}))}function f(e){const t=document.createEvent("MouseEvent");t.initEvent("click",!0,!0),e.dispatchEvent(t)}function y(e){return i(this,void 0,void 0,(function*(){(0,n.log)("VideoPlayer",n.Level.INFO,"Playback ended, sending notification..."),yield function(e){return i(this,void 0,void 0,(function*(){if(null!=e&&e.isMovie){const t=yield(0,s.getConfig)();t.notifyVideoStateChange&&((0,n.log)("Notify",n.Level.INFO,"Notifying video playback ended"),a(t,t.discordPlaybackEndedMessage.replace("%title%",e.title)),d(t,t.desktopPlaybackEnded,e.title),(0,n.log)("Notify",n.Level.INFO,"Successfully sent video playback ended notify."))}}))}(c()),(0,n.log)("VideoPlayer",n.Level.INFO,"Successfully sent notification!");const e=yield(0,s.getConfig)();if(e.useAutoNext){(0,n.log)("Automation",n.Level.INFO,"useAutoNext is active, finding next chapter...");const t=u(e.useAutoNextContainsSupplements,e.useAutoNextNotGoodOnly);if(null!=t)if((0,n.log)("Automation",n.Level.INFO,"Chapter found: "+t.title),t.isGateClosed){let e;(0,n.log)("Automation",n.Level.INFO,"Gate is closed, use MutationObserver to observe changes...");const o=()=>i(this,void 0,void 0,(function*(){(0,n.log)("Automation/Observer",n.Level.INFO,"Attributes changed, clicking."),t.isMovie?yield g():(t.isEssayTest||t.isEvaluationTest)&&(yield v()),e.disconnect()}));e=new MutationObserver(o),e.observe(t.element.querySelector("a"),{attributes:!0})}else(0,n.log)("Automation",n.Level.INFO,"Gate is already opened, clicking."),t.isMovie?yield g():(t.isEssayTest||t.isEvaluationTest)&&(yield v())}}))}function p(e){(0,n.log)("VideoPlayer",n.Level.INFO,"Video seeking detected, cancelling this."),e.preventDefault(),e.stopImmediatePropagation()}function m(e){let t=[0,0,0];return t[0]=Math.floor(e/3600),t[1]=Math.floor(e%3600/60),t[2]=e%60,t}function N(e,t){return("0".repeat(t)+e).slice(-t)}"denied"!=window.Notification.permission&&"default"!=window.Notification.permission||window.Notification.requestPermission().then((()=>{"granted"==window.Notification.permission?(0,n.log)("Permission",n.Level.INFO,"Desktop Notification Permission is now accepted."):(0,n.log)("Permission",n.Level.WARN,"Desktop Notification Permission is not accepted, desktop notifications will be not sent to you.")})),document.getElementById("modal-inner-iframe")instanceof HTMLIFrameElement||(new MutationObserver((()=>{(0,n.log)("MutationObserver",n.Level.INFO,"DOM change detected, registering 'load' event to iFrame (#modal-inner-iframe)!");const e=document.getElementById("modal-inner-iframe");null!=e?(e.addEventListener("load",(t=>{if((0,n.log)("iFrame",n.Level.INFO,"iFrame loaded."),(0,n.log)("iFrame",n.Level.INFO,"Checking iFrame contentWindow..."),null!=e.contentWindow){(0,n.log)("iFrame",n.Level.INFO,"iFrame contentWindow found!");const t=c();if(null==t)return;if(t.isEssayTest||t.isEvaluationTest||!t.isMovie)(0,n.log)("iFrame",n.Level.INFO,"Opened iFrame is Essay or Evaluation test, skipping.");else if((0,n.log)("iFrame",n.Level.INFO,"Finding VideoPlayer..."),e.contentWindow.document.getElementById("video-player")instanceof HTMLMediaElement)(0,n.log)("iFrame",n.Level.INFO,"VideoPlayer already loaded, use this."),l(e).then((()=>(0,n.log)("iFrame",n.Level.INFO,"Successfully registered video events.")));else{(0,n.log)("iFrame",n.Level.INFO,"VideoPlayer not loaded, use setInterval to try find...");const t=setInterval((()=>{null!=e.contentWindow&&null!=e.contentWindow.document.getElementById("video-player")&&((0,n.log)("iFrame/Timer",n.Level.INFO,"VideoPlayer loaded!"),clearInterval(t),l(e).then((()=>(0,n.log)("iFrame",n.Level.INFO,"Successfully registered video events."))))}),10)}}})),(0,n.log)("MutationObserver",n.Level.INFO,"Successfully registered 'load' event to iFrame (#modal-inner-iframe)")):(0,n.log)("MutationObserver",n.Level.ERROR,"Failed to find iFrame (#modal-inner-iframe)! Event is not registered.")})).observe(document.querySelector('div[data-react-class="App.Modal"]'),{childList:!0}),(0,s.getConfig)().then((e=>{if(e.autoOpenChapterWhenOpenPage){const t=u(e.useAutoNextContainsSupplements,e.useAutoNextNotGoodOnly);null!=t&&((0,n.log)("main",n.Level.INFO,"Auto clicking next chapter."),f(t.clickTarget))}})));const h=r(),k=h.filter((e=>e.isMovie)),O=k.filter((e=>e.isGood)),I=k.filter((e=>!e.isSupplement)),F=O.filter((e=>!e.isSupplement)),L=k.filter((e=>e.isSupplement)),b=O.filter((e=>e.isSupplement)),E=h.filter((e=>e.isEssayTest||e.isEvaluationTest)),S=E.filter((e=>e.isGood));let T=0,C=0,P=0;I.forEach((e=>{T+=e.movieTimeSeconds,e.isGood?C+=e.movieTimeSeconds:P+=e.movieTimeSeconds}));let A=0,M=0,R=0;L.forEach((e=>{A+=e.movieTimeSeconds,e.isGood?R+=e.movieTimeSeconds:M+=e.movieTimeSeconds}));const w=m(T),x=m(C),D=m(P),G=m(A),W=m(R),V=m(M);let U=document.getElementsByClassName("description");void 0===U&&location.reload(),U[0].innerHTML="<div class='u-card'><div class='u-list-header typo-list-title'>この単元の進捗状況</div><div class='u-card-inner'>[必修教材]<br>視聴済み動画本数: "+F.length+"/"+I.length+"本<br>受講済みテスト数: "+S.length+"/"+E.length+"個<br>合計動画時間: "+(w[0]>0?N(w[0],2)+"時間":"")+N(w[1],2)+"分"+N(w[2],2)+"秒<br>視聴済み動画時間: "+(x[0]>0?N(x[0],2)+"時間":"")+N(x[1],2)+"分"+N(x[2],2)+"秒<br>未試聴動画時間: "+(D[0]>0?N(D[0],2)+"時間":"")+N(D[1],2)+"分"+N(D[2],2)+"秒<br><br>[Nプラス教材]<br>視聴済み動画本数: "+b.length+"/"+L.length+"本<br>合計動画時間: "+(G[0]>0?N(G[0],2)+"時間":"")+N(G[1],2)+"分"+N(G[2],2)+"秒<br>視聴済み動画時間: "+(W[0]>0?N(W[0],2)+"時間":"")+N(W[1],2)+"分"+N(W[2],2)+"秒<br>未試聴動画時間: "+(V[0]>0?N(V[0],2)+"時間":"")+N(V[1],2)+"分"+N(V[2],2)+"秒<br></div></div>"+U[0].innerHTML},473:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.log=t.ASCIIColor=t.Level=void 0,t.Level={INFO:"INFO",WARN:"WARN",ERROR:"ERROR",DEBUG:"DEBUG"},t.ASCIIColor={BLACK:"[30m",GRAY:"[90m",DARK_RED:"[31m",RED:"[91m",DARK_GREEN:"[32m",GREEN:"[92m",DARK_YELLOW:"[33m",YELLOW:"[93m",DARK_BLUE:"[34m",BLUE:"[94m",DARK_PURPLE:"[35m",PURPLE:"[95m",DARK_AQUA:"[36m",AQUA:"[96m",DARK_WHITE:"[37m",WHITE:"[97m",RESET:"[0m"},t.log=function(e,o,i){let n=o==t.Level.INFO?t.ASCIIColor.WHITE:o==t.Level.WARN?t.ASCIIColor.DARK_YELLOW:o==t.Level.ERROR?t.ASCIIColor.DARK_RED:t.ASCIIColor.GRAY;console.log(n+"["+new Intl.DateTimeFormat("ja-JP",{timeStyle:"medium"}).format(new Date)+"] ["+e+"] ["+o+"] "+i+t.ASCIIColor.RESET)}}},t={};!function o(i){var n=t[i];if(void 0!==n)return n.exports;var s=t[i]={exports:{}};return e[i].call(s.exports,s,s.exports,o),s.exports}(144)})();