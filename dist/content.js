(()=>{"use strict";const e="不明なテスト",t="INFO",i="WARN",n="ERROR";function o(e,o,s){let a=o==t?"[97m":o==i?"[33m":o==n?"[31m":"[90m";console.log(a+"["+new Intl.DateTimeFormat("ja-JP",{timeStyle:"medium"}).format(new Date)+"] ["+e+"] ["+o+"] "+s+"[0m")}function s(s){if(o("iFrame",t,"Checking iFrame contentWindow..."),null!=s.contentWindow){o("iFrame",t,"Successfully get iFrame document."),o("iFrame",t,"Finding VideoPlayer (#video-player)");const d=s.contentWindow.document.getElementById("video-player");null!=d?(o("VideoPlayer",t,"Successfuly found video! "+d),o("VideoPlayer",t,'Regsitering "ended" event to target video!'),d.addEventListener("ended",(n=>{o("VideoPlayer",t,"Playback ended, sending notification..."),o("Notify",t,"Notify process started..."),o("Notify",t,"Finding iFrame..."),document.getElementById("modal-inner-iframe"),setTimeout((()=>{const n=l(!1);if(o("Automation",t,"Finding next video or test..."),null!=n)o("Automation",t,"Next video found! clicking."),r(n.clickTarget);else{o("Autoamtion",t,"Next video not found! Finding test...");const n=function(){const e=a().filter((e=>(e.isEssayTest||e.isEvalutionTest)&&!e.isGateClosed&&!e.isGood&&!e.isOpened));return e.length>0?e[0]:null}();null!=n&&(o("Automation",t,"Next test found!, sending notify."),function(e){if("".length>0){o("Discord",t,"Sending notification to discord.");const n=new XMLHttpRequest;n.open("POST",""),n.setRequestHeader("Content-Type","application/json"),n.addEventListener("readystatechange",(e=>{4==n.readyState&&(204==n.status?o("Discord",t,"Successfully sent notification to discord."):400==n.status&&(o("Discord",i,"Failed to sent notification to discord."),o("Discord",i,n.responseText)))})),n.send(JSON.stringify({username:"N予備校",avatar_url:"https://www.nnn.ed.nico/favicon.ico",content:e}))}}(" テスト `%title%` を受けてください".replace("%title%",null!=n?n.title:e)),function(e,t){const i=new Notification(e,{body:t,icon:"https://www.nnn.ed.nico/favicon.ico"});setTimeout(i.close.bind(i),5e3)}("テストを受けてください",null!=n?n.title:e),o("Automation",t,"Successfully sent next test notify."))}}),1500),o("VideoPlayer",t,"Successfully sent notification!")})),o("VideoPlayer",t,'Successfully registered "ended" event to target video!'),o("VideoPlayer",t,'Registering "pause" event to target video!'),d.addEventListener("pause",(e=>{d.currentTime!=d.duration&&(o("VideoPlayer",t,"\nDamn, that trashy high school just paused the video!\nI'll never forgive you! I'm gonna resume playback!\nLMAO."),e.preventDefault(),e.stopImmediatePropagation(),d.play())})),o("VideoPlayer",t,'Successfully registered "pause" event to target video!'),o("VideoPlayer",t,'Registering "seeking" event to target video!'),d.addEventListener("seeking",(e=>{e.preventDefault(),e.stopImmediatePropagation()})),o("VideoPlayer",t,'Successfuly registered "seeking" event to target video!'),o("VideoPlayer",t,'Registering "seeked" event to target video!'),d.addEventListener("seeked",(e=>{e.preventDefault(),e.stopImmediatePropagation()})),o("VideoPlayer",t,'Successfully registered "seeked" event to target video!')):o("VideoPlayer",n,"Failed to find video!")}else o("iFrame",n,"Failed to get iFrame document!")}function a(){const e=document.querySelectorAll("div.l-contents#sections-contents>div.section>div.u-card>ul.u-list>li"),t=[];return e.forEach(((e,i)=>{const n=e.className,o=e.getElementsByTagName("a");let s=-1;if(n.includes("movie")){const t=e.querySelector("a>div.section-optional-info>p.content-amount.movie-length").innerText.split(":");2==t.length?s=60*Number(t[0])+Number(t[1]):3==t.length&&(s=60*Number(t[0])*60+60*Number(t[1])+Number(t[2]))}let a={title:e.querySelector("a>div.section-main-info>div>p>span.title").innerText,isGood:n.includes("good"),isMovie:n.includes("movie"),isSupplement:n.includes("supplement"),isEvalutionTest:n.includes("evaluation-test"),isEssayTest:n.includes("essay-test"),isOpened:o.length>0&&o[0].className.includes("is-selected"),isGateClosed:o.length>0&&o[0].className.includes("is-gate-closed"),movieTimeSeconds:s,element:e,clickTarget:o.length>0?o[0]:null};t[i]=a})),t}function l(e){const t=a().filter((t=>t.isMovie&&!t.isOpened&&!t.isGood&&!t.isGateClosed&&(e&&t.isSupplement||!t.isSupplement)));return t.length>0?t[0]:null}function r(e){const t=document.createEvent("MouseEvent");t.initEvent("click",!0,!0),e.dispatchEvent(t)}if("denied"!=window.Notification.permission&&"default"!=window.Notification.permission||window.Notification.requestPermission().then((()=>{"granted"==window.Notification.permission?o("Permission",t,"Desktop Notification Permission is now accepted."):o("Permission",i,"Desktop Notification Permission is not accepted, desktop notifications will be not sent to you.")})),document.getElementById("modal-inner-iframe")instanceof HTMLIFrameElement)o("main",n,"iFrame already appended, please reload page and execute this script before start playback.");else{new MutationObserver((()=>{o("MutationObserver",t,"DOM change detected, registering 'load' event to iFrame (#modal-inner-iframe)!");const e=document.getElementById("modal-inner-iframe");null!=e&&null!=e?(e.addEventListener("load",(i=>{if(o("iFrame",t,"iFrame loaded."),o("iFrame",t,"Checking iFrame contentWindow..."),null!=e.contentWindow){o("iFrame",t,"iFrame contentWindow found!");const i=function(){const e=a().filter((e=>e.isOpened));return e.length>0?e[0]:null}();if(null==i)return;if(i.isEssayTest||i.isEvalutionTest||!i.isMovie)o("iFrame",t,"Opened iFrame is Essay or Evalution test, skipping.");else if(o("iFrame",t,"Finding VideoPlayer..."),e.contentWindow.document.getElementById("video-player")instanceof HTMLMediaElement)o("iFrame",t,"VideoPlayer already loaded, use this."),s(e);else{o("iFrame",t,"VideoPlayer not loaded, use setInterval to try find...");const i=setInterval((()=>{if(null!=e.contentWindow){const n=e.contentWindow.document.getElementById("video-player");null!=n&&null!=n&&(o("iFrame/Timer",t,"VideoPlayer loaded!"),clearInterval(i),s(e))}}),10)}}})),o("MutationObserver",t,"Successfully registered 'load' event to iFrame (#modal-inner-iframe)")):o("MutationObserver",n,"Failed to find iFrame (#modal-inner-iframe)! Event is not registered.")})).observe(document.querySelector('div[data-react-class="App.Modal"'),{childList:!0});{const e=l(!1);null!=e&&(o("main",t,"Auto playback starting."),r(e.clickTarget))}}const d=a();let c=0,u=0,m=0;d.forEach((e=>{e.isMovie&&!e.isSupplement&&(c+=e.movieTimeSeconds,e.isGood?u+=e.movieTimeSeconds:m+=e.movieTimeSeconds)}));let f=0,v=0,g=0;d.forEach((e=>{e.isMovie&&e.isSupplement&&(f+=e.movieTimeSeconds,e.isGood?g+=e.movieTimeSeconds:v+=e.movieTimeSeconds)}));let p=c+f;Math.floor(p/3600);const y=Math.floor(c/3600),h=Math.floor(f/3600),F=(Math.floor(p%3600/60),Math.floor(c%3600/60)),E=Math.floor(f%3600/60);let M="必修教材: "+(y>0?y+"時間":"")+F+"分"+c%60+"秒",N="Nプラス教材: "+(h>0?h+"時間":"")+E+"分"+f%60+"秒";const b=Math.floor(u/3600),S=Math.floor(u%3600/60),T=u%60,w=Math.round(u/c*100),P=Math.floor(m/3600),k=Math.floor(m%3600/60);let V="視聴済み必修教材: "+(b>0?b+"時間":"")+(S>0?S+"分":"")+T+"秒 ("+w+"%)",I="未視聴必修教材: "+(P>0?P+"時間":"")+(k>0?k+"分":"")+m%60+"秒";const O=Math.floor(g/3600),D=Math.floor(g%3600/60),L=g%60,A=Math.round(g/f*100),B=Math.floor(v/3600),R=Math.floor(v%3600/60);let W="視聴済みNプラス教材: "+(O>0?O+"時間":"")+(D>0?D+"分":"")+L+"秒 ("+A+"%)",x="未試聴Nプラス教材: "+(B>0?B+"時間":"")+(R>0?R+"分":"")+v%60+"秒",C=document.getElementsByClassName("description");void 0===C&&location.reload();let q=document.querySelectorAll("li.movie:not(.supplement)").length,G=(document.getElementsByClassName("movie").length,document.getElementsByClassName("evaluation-test").length);C[0].innerHTML="<div class='u-card'><div class='u-list-header typo-list-title'>この単元の進捗状況</div><div class='u-card-inner'>[合計]<br>"+M+"<br>"+N+"<br><br>[必修]<br>"+V+"<br>"+I+"<br><br>[Nプラス]<br>"+W+"<br>"+x+"<br><br>[本数]<br>必修教材動画数: "+q+"本<br>確認テストの数: "+G+"個</div></div>"+C[0].innerHTML})();